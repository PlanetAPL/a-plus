ãã Copyright (c) 1990-2008 Morgan Stanley All rights reserved.
ãã See .../src/LICENSE for terms of distribution.

$cx fcp

set_menu{s;d;i;p;c;v}:
	{
	case (qû0#¢1Ùp)
		{
		`Cut;		cut_field{c};
		Â"Paste Right";	paste_field{c;1};
		Â"Paste Left";	paste_field{c;0};
				buffer{c} Ý (c%`_TABLE)ûq;
		}
	}

focus{}:2Ùif (0<#wûs.this{}) if (0<#tû0Ø`focus .of w) if (`table½0Ø`class .of t) (t;0Ø`field .of t)

paste_field{c;k}:
	{
	if (~()½t Ý (t;f)ûfocus{})
		{
		if (tÅ0Øcb Ý cbûc%`_CUT_BUFFER)
			{
			flûtØcb;
			(g;fl)û(0#fl;1Õfl);
			if (0=#fl) cbû(<t¨0Øcb)/¡cb else (tØcb)ûfl;
			(%t)ûif (()½f) ,g else Ø(iÙv),g,iÕv Ý iûk+vÉf Ý vû%t;
			(c%`_CUT_BUFFER)ûcb;
			}
		}
	}

cut_field{c}:
	{
	if (~()½f Ý (t;f)ûfocus{})
		{
		if (~tÅ0Øcb Ý cbûc%`_CUT_BUFFER) cbûcb,¡(t;<());
		(c%`_CUT_BUFFER)ûcb Ý (tØcb)ûf,tØcb Ý (%t)û(~vÅf)/v Ý vû%t;
		};
	}

buffer{c}:if (0<#c%`_BUFFER) .show c,`_BUFFER Ý (c,`_BUFFER) .has (`title;0Ø`title .of c%`_TABLE)
title{f}:if (0<#ft Ý ftû0Ø`title .of f) f else Îf

buffer_fields{t;cb}:if (0=#t) 0 0Ò'' else if (tÅ0Øcb) >(Ó/>#¡g)Ù¡gûtitle¡{(0#Öt)ÖtØcb}

adjust{c;v;r;i}:if (1<#d Ý dûc%v) (()#c%v)ût Ý ((~b)/t)û(,i)#d Ý tûb\t Ý tû(k¨i)/d Ý bûk¨r Ý kûÉ#d
sel_r{s;c;v}:if (1=#0Ø(i;r)û`index `row .of c,v) (c,v) .has (`index;r) Ý adjust{c;v;r;i}
ref_r{s;c;v}:if (i½r Ý (i;r)û`index `row .of c,v) (c,v) .has (`index;É0) else (c,v) .has (`index;r)

tables{t}:if (0<#t) t else (`table=_flat{`class .of¡obs})/obs Ý obsûs.objects{}
edit_menu{t}:(`Fields;<(`Cut,(Â"Paste Left"),(Â"Paste Right"),`Buffer;(;;;(t;(#t)Ù())))) Ý tûtables{t}

define{cx}:
	{
	WSûs.autows{()};

	cxâ'_FCP:fcp.edit_menu{_TABLES} Ý s.SYMBOLS';
	cxâ'_BUFFER:fcp.buffer_fields{_TABLE;_CUT_BUFFER}';
	(cx%`_TABLE)û();
	(cx%`_TABLES)û();
	(cx%`_CUT_BUFFER)û(;);

	(cx,`_FCP) .is `hmenu;
	(cx,`_BUFFER) .is `array;

	(cx,`_FCP) .has (`set;set_menu;`acceptfocus;0;`font;'kaplscreen-bold';`labelfont;'kaplscreen-bold');
	(cx,`_BUFFER) .has (`protect;1;`rows;5;`select;sel_r;`refer;ref_r;`title;'';`font;'kaplscreen-bold';`title;'kaplscreen-bold');

	s.autows{WS};
	s.SYMBOLSûs.SYMBOLS;

	cxÖ`_FCP
	}
