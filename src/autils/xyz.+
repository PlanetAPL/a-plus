ãã Copyright (c) 1990-2008 Morgan Stanley All rights reserved.
ãã See .../src/LICENSE for terms of distribution.

$cx xyz

if( ()½scriptsDirûsys.readenv{"UTILS_DIR"} ) {
  scriptsDirû"/usr/local/aplus-fsf-4.22/autils";
}

_load{scriptsDir,"/box"}

type{fs}:
	{
	if (`box=tyû©%0#fs) û`box;
	(iû¢1+#fs) do if (ty¨©%(i+1)#fs) û`box;
	ty
	}

title{c;v}:if (0<#zû0Ø`title .of v) ,z else if (c=a Ý (a;b)ûÖv) Îb else Îv
out{v;x}:if (0<#zû0Ø(`out;x) .of v) ,z else box.out{x}

comb{x;s}:z Ý (iû#x Ý zû() Ý kû«/s) do z[,]û<kÒ(«/(i+1)Õs)/iØx
repl{x;s}:z Ý (iû#x Ý zû() Ý jû1,«\¢1Õs Ý kû«/s) do z[,]û<(k,¢1ÙÒt)Ò(0=(kßj[i+1])|Ékßj[i])\tûiØx

vltm{x}:>(Ó/>#¡x)Ù¡x

pre_go{s;d;i;p;c;v}:if (d½1) d else Ù`type

go{s;d;i;p;c;v}:
	{
	if (d½1)
		{
		cxûc%`_CX;
		yyû,if (0<½yyûc%`_YY) yy else <yy;
		xxû,if (0<½xxûc%`_XX) xx else <xx;
		ysû,cxÖc%`_Y;
		xsû,cxÖc%`_X;
		zsû,cxÖc%`_Z;
		if (0Å>#¡(yy;xx;ys;xs;zs)) û();
		yû%¡ys;
		xû%¡xs;
		tyûtype{zs};
		
		szû#zs;
		syû#yy;
		sxû#xx;
		sû>(#¡yy),#¡xx;

		(c%`_I)ût.link_index{y,x;comb{yy,xx;s}};
		mû(sz,(«/syÙs),«/syÕs)Òif (ty=`box) <() else tyØt.NA;
		(iûsz) do
			{
			if ((`box¨ktyû©k)^ty=`box Ý kût.index{c%`_I;i#zs}) ((kÅ<t.na{i#zs})/k)û<() Ý kûÛ¡k;
			m[i]û(1ÕÒm)Òk
			};

		ztûvltm{title¡{cx;zs}};
		
		ytûrepl{vltm¡{(<¡title¡{cx;ys},¡'='),¡¡out¡¡{ys;yy}};(syÙs),sz};
		ytûôØ(ô¡yt,<((«/(syÙs),sz),¢1ÙÒzt)Òzt),¡' ';

		xtûrepl{vltm¡{(<¡title¡{cx;xs},¡'='),¡¡out¡¡{xs;xx}};(syÕs),1};
		xtûvltm¡<@1ô><@1¡xt;

		xytû((#xyt)Ó¢1ÙÒyt)Ùxyt Ý xytû'(',(1ÕØ' ',¡1Õ¡î¡syÙs),')«(',(1ÕØ' ',¡1Õ¡î¡syÕs),') ';

		(c%`_M)û!1 0 2ôm;
		(c,`_M) .has (`label;(xyt;yt;xt);`rowsep;sz;`protect;1;`colspace;(1+1ÕÒyt),(#xt)Ò1+Ó/>¢1Ù¡Ò¡xt;`collabelrows;#0Øxt);
		}
	}

define{cx}:
	{
	WSûs.autows{()};

	_scb{cxÖ`_GO;(;)};
	_spcb{cxÖ`_GO;(;)};

	(cx%`_GO)û0;

	_scb{cxÖ`_GO;(go;)};
	_spcb{cxÖ`_GO;(pre_go;)};
	
	(cx%`_YY)û();
	(cx%`_XX)û();

	(cx%`_Y)û();
	(cx%`_X)û();

	(cx%`_Z)û();

	(cx%`_CX)û();

	(cx%`_I)ûÉ0;
	(cx%`_M)û0 0Ò();

	(cx%`_XYZ)û`_M;

	(cx,`_M) .is `matrix;
	(cx,`_XYZ) .is `layout;

	(cx,`_M) .has (`title;'';`blank;'');
	(cx,`_XYZ) .has (`title;'');
	
	s.autows{WS};

	cxÖ`_XYZ
	}
