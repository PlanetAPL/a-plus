ãã Copyright (c) 1990-2008 Morgan Stanley All rights reserved.
ãã See .../src/LICENSE for terms of distribution.
$cx bfm

USERNAMEûsys.getusername{}

set_files{s;d;i;p;c;v}:
	{
	(c,`_FILES) .has (`freeze;1);
	(c%`_FILE)û'';
	xûsys.agetdents{c%`_DIR};
	if (0<#s Ý sûc%`_SUFFIX)
		{
		xûôx;
		dû-#s;
		xûô(-+/^\÷x=' ')÷x;
		xûdÕ@1 fxû(^/@1 (dÙ@1 x)=@1 s)/x;
		xû(~^/~©\@1 ' '¨x)/@1 x;
		xû((x=' ')É@1Û0)÷@0 1x;
		};
	(c%`_NAMES)ûx;
	(c%`_DATES)û(#x)Ùc%`_DATES;
	(c%`_TIMES)û(#x)Ùc%`_TIMES;
	if (0<#x)
		{
		xûif (0<#s) ((fx=' ')É@1Û0)÷@0 1 fx else c%`_NAMES;
		tû(;9)#sys.astat{(c%`_DIR),@1 x};
		ixûif (c%`_SORT) çt else èc%`_NAMES;
		tû>sys.ts1¡{ix#t};
		(c%`_DATES)û100Â@1 t[;É3];
		(c%`_TIMES)û0 60 60Â@1 t[;3+É3];
		(c%`_NAMES)ûix#c%`_NAMES;
		};
	(c,`_FILES) .has (`row;¢1);
	(c,`_NAMES) .has (`space;1#Òx);
	(c,`_FILES) .has (`freeze;0);
	}

dltb{x}:((÷©\÷x¨' ')^©\x¨' ')/x

select_file{s;c;v}:(c%`_FILE)ûif (¢1=rû0Ø`row .of c,v) '' else dltb{r#c%`_NAMES},c%`_SUFFIX

preset_new{s;d;i;p;c;v}:dltb{d}

preset_mode{s;d;i;p;c;v}:if (dÅ0Øc%`_MODES) d else Ù`domain
set_mode{s;d;i;p;c;v}:(dØc%`_MODES)û1 Ý (1Øc%`_MODES)ûÛ¡d=0Øc%`_MODES

set_modes{s;d;i;p;c;v}:
	{
	if (`sym¨©p) û();
	(c,`_MODE) _spcb (;);
	(c,`_MODE) _scb (;);
	(c%`_MODE)ûp;
	(c,`_MODE) _spcb (preset_mode;);
	(c,`_MODE) _scb (set_mode;);
	case (p)
		{
		`get;	get_mode{c};
		`put;	put_mode{c};
		`drop;	drop_mode{c};
		}
	}

get_mode{c}:(c,`_USER) .has (`protect;0) Ý (c,`_NEW) .has (`protect;1) Ý (c%`_NEW)û''
put_mode{c}:(c,`_USER) .has (`protect;1) Ý (c%`_USER)ûUSERNAME Ý (c,`_NEW) .has (`protect;0)
drop_mode{c}:(c,`_USER) .has (`protect;1) Ý (c%`_USER)ûUSERNAME Ý (c,`_NEW) .has (`protect;1) Ý (c%`_NEW)û''

define{cx}:
	{
	WSûs.autows{()};

	(cx%`_FONT)û'kaplscreen-bold';
	(cx%`_DATEFMT)û`mdy;
	(cx%`_TIMEFMT)û`hrmin24;
	(cx%`_SORT)û1;

	(cx%`_MODE)û`get;

	(cx%`_USER)ûUSERNAME;
	(cx%`_FILE)û'';
	(cx%`_APPL)û'';
	(cx%`_SUFFIX)û'';
	(cx%`_TRIGGER)û0;

	cxâ"_DIR:'/u/',_USER,'/',_APPL,'/'";

	(cx%`_NAMES)û0 0Ò'';
	(cx%`_DATES)û0Ò0;
	(cx%`_TIMES)û0Ò0;

	(cx%`_MODES)û(`get `put `drop;(1;0;0));
	(cx%`_NEW)û'';
	(cx%`_BFM)û(`_MODES;`_USER;`_FILES;`_NEW);

	(cx,`_MODES) .is `radio;
	(cx,`_USER) .is `scalar;
	(cx%`_FILES)ûcxÖ`_NAMES `_DATES `_TIMES;
	(cx,`_FILES) .is `table;
	(cx,`_NEW) .is `scalar;
	(cx,`_BFM) .is `layout;

	(cxÖ`_USER `_APPL `_SUFFIX `_TRIGGER `_SORT) _scb¡<(set_files;);

	(f;d;t)ûcxÖ`_FONT `_DATEFMT `_TIMEFMT;

	(cx,`_MODES) s.uses (`font;f;`titlefont;f;`labelfont;f);
	(cx,`_USER) s.uses (`font;f;`titlefont;f);
	(cx,`_NEW) s.uses (`font;f;`titlefont;f);
	(cx,`_FILES) s.uses (`font;f;`titlefont;f);
	(cx,`_DATES) s.uses (`out;d);
	(cx,`_TIMES) s.uses (`out;t);
	
	(cx,`_MODE) .has (`preset;preset_mode;`set;set_mode);
	(cx,`_MODES) .has (`title;'';`geometry;`horizontal;`label;`Get `Put `Drop;`set;set_modes;`acceptfocus;0);
	(cx,`_USER) .has (`title;'User:');
	(cx,`_FILES) .has (`title;'';`rows;7;`cols;#cx%`_FILES;`select;select_file;`protect;1;`rowsep;0);
	(cx,`_NAMES) .has (`title;('Current';'Files  ');`space;25);
	(cx,`_DATES) .has (`title;('Update';'Date  ');`space;#(cx%`_DATEFMT) _sfmt 19800101);
	(cx,`_TIMES) .has (`title;(;'Time'));
	(cx,`_NEW) .has (`title;'New:';`preset;preset_new);
	(cx,`_BFM) .has (`title;'';`dynamic;1);
	
	s.autows{WS};

	cxÖ`_BFM
	}





