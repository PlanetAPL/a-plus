ãã Copyright (c) 1990-2008 Morgan Stanley All rights reserved.
ãã See .../src/LICENSE for terms of distribution.

$cx dlu

tree{p}:prefix{Âp;dir_tree{p;1}}
prefix{p;t}:if (2=#t) (q;&¡{q;1Øt}) İ qû>Â¡(<(Îp),'/'),¡Î¡0Øt

dir_tree{p;g}:if (g) dir_tree_0{(p;'');É0} else (;)
dir_tree_0{pd;st}:
	{
	if (0<#dsûagetdents{p} İ pûp,('/'¨¢1Ùp)/'/' İ pûØpd) 
	if (0<#i İ (i;st)ûis_dir{p;ds;st}) (ØÂ¡ds;&¡{((<<p),¡<¡ds);<st}) İ dsû(ds¨¡' ')/¡dsû<@1 i#ds
	}

is_dir{y;x;st}:
	{
	kû(;1 2)#sys.astat{y,@1 1 x};
	bû(~k[;0]Åst)^0#(15Ò2)Îk[;1];
	st[,]ûb/k[;0];
	(b/É#b;st)
	}

is_file{dir;mat}:(~jÅk)/j İ jûÉ#mat İ kû1Øis_dir{dir;mat;É0}

rj{x}:(-(' '=÷@1 x)É@1Û0)÷@0 1x

file_list{dir;fs}:
	{
	zûif (0=#matûagetdents{dir}) mat
	else if (~©/k İ kû>1Øfs) is_file{dir;mat}#mat
	else b/mat İ bû©/>b½@1¡'.',¡sfs İ bû(-1+>#¡sfs İ sfsûÎ¡k/0Øfs)Ù@1¡<rj{mat};
	(èz)#z
	}

agetdents{x}:(èz)#z İ zûsys.agetdents{x}

set_dirs{s;d;i;p;c;v}:(c,`_FILES) .has (`firstrow;0;`row;¢1) İ (c%`_FILE)û'' İ if (~p½()) (c%`_DIR)û(c%`_PATH),(('/'¨¢1Ùc%`_PATH)/'/'),Ø(Î¡p),¡'/'

select_file{s;c;v}:if (0¤i İ iû0Ø`row .of c,v) (c%`_FILE)ûf İ fû(f¨' ')/f İ fûi#c%v

d_d{x}:if (~':'Åx) ('';x) else (iÙx;iÕx) İ iû1+xÉ':'
preset_path{s;d;i;p;c;v}:y,if (0=#z İ (y;z)ûd_d{(d¨' ')/d}) './' else if ('/'=¢1Ùz) z else z,'/'
set_path{s;d;i;p;c;v}:(c%`_GO)û1

read{x}:if (('/'=¢1Ùx)©^/x=' ') 0 0Ò'' else if (0=rc İ (rc;z)ûdo sys.readmat{x}) z else 0 0Ò''

define{cx}:
	{
	WSûs.autows{()};

	(cx%`_GO)û0;
	(cx%`_PATH)û'';
	(cx%`_FILTERS)û(;);

	cxâ'_DIRS:dlu.dir_tree{_PATH;_GO}';
	(cx%`_DIRWIN)û`_DIRS;
	(cx%`_DIR)û'./';
	cxâ'_FILES:dlu.file_list{_DIR;_FILTERS}';
	(cx%`_FILE)û'';
	(cx%`_PANE)û`_DIRWIN `_FILES;
	(cx%`_DLU)û(`_PATH;`_PANE;`_FILTERS);

	cxâ'_VIEW:dlu.read{_DIR,_FILE}';
	(cx,`_VIEW) .is `view;

	(cx,`_FILES) .is `view;
	(cx,`_DIRS) .is `tree;
	(cx,`_DIRWIN) .is `window;
	(cx,`_PATH) .is `scalar;
	(cx,`_FILTERS) .is `check;
	(cx,`_PANE) .is `vpane;
	(cx,`_DLU) .is `layout;

	(cx,`_FILES) .has (`title;'Files';`select;select_file);
	(cx,`_DIRS) .has (`title;'';`set;set_dirs;`dynamic;1;`hl;`grey);
	(cx,`_PATH) .has (`title;'Path:';`preset;preset_path;`set;set_path);
	(cx,`_PANE) .has (`title;'');
	(cx,`_FILTERS) .has (`geometry;¢2;`title;'';`acceptfocus;0);
	(cx,`_DLU) .has (`title;'');
	
	s.autows{WS};
	
	cxÖ`_DLU
	}
