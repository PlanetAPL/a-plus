ãã Copyright (c) 1990-2008 Morgan Stanley All rights reserved.
ãã See .../src/LICENSE for terms of distribution.

$cx qio

SFIû(_sfi;_scfi)

in{s;d;i;p;c;v}:s.in{in_;d;i;p;c;v}
out{s;d;i;p;c;v}:s.out{out_;d;i;p;c;v}
	
forms{}:
	{
	(NUMS)û"1234567890";
	(FORMS)û`decimal `decimal_32nd `8th_32nd `decimal_64th `integer;
	(DENS)û1 32 32 64 1;
	(PRECS)û3 3 3 3 0;
	}

forms{}

default{a}:
	{
	rû();
	(fm;pr)û(`decimal;3);
	iûFORMSÉfm;

	if (`formÅ0Øa) 		if (`decimal½fmû`formØa) 		r[,]û`form;
	if (`maxÅ0Øa) 		if (Inf½`maxØa) 			r[,]û`max;
	if (`minÅ0Øa) 		if (¢Inf½`minØa) 			r[,]û`min;
	if (`formsÅ0Øa) 	if (()½`formsØa) 			r[,]û`forms;
	if (`precisionÅ0Øa) 	if (PRECS[i]½prû`precisionØa) 		r[,]û`precision;
	if (`commaÅ0Øa) 	if (0½`commaØa) 			r[,]û`comma;
	if (`fuzzÅ0Øa) 		if (1½`fuzzØa) 				r[,]û`fuzz;
	if (`plusÅ0Øa) 		if (0½`plusØa) 				r[,]û`plus;
	if (`zeroÅ0Øa) 		if (1½`zeroØa) 				r[,]û`zero;
	if (`roundÅ0Øa) 	if (0½`roundØa) 			r[,]û`round;
	if (`widthÅ0Øa) 	if ((4+pr)½`widthØa) 			r[,]û`width;
	if (`naÅ0Øa) 		if (¢999999999.0½`naØa)			r[,]û`na;

	if (0<#r) aû(<~(0Øa)År)/¡a;
	if (a½(;)) aû();
	a	
	}

in_{x}:
	{
	(x;attr)ûif (0=½x) (x;) else 2Ùx;
	attrû2Ùattr;

	tûif (~`formsÅ0Øattr) FORMS else if (()½tû`formsØattr) FORMS else t;
	(forms;dens)û(<FORMSÅt)/¡(FORMS;DENS);
	lwûif (`minÅ0Øattr) `minØattr else ¢Inf;
	upûif (`maxÅ0Øattr) `maxØattr else Inf;
	blûif (`naÅ0Øattr) `naØattr else ¢999999999.0;
	fuûif (`fuzzÅ0Øattr) `fuzzØattr else 1;

	if (^/s=' ' Ý sû,x) û(bl;attr);
	if (~1=+/t>1÷tû' '=' ',s Ý sû(+/^\s=' ')÷s) Ù`domain;
	if (i<3 Ý iû"+-¢"É0#s) sû1÷s Ý s[0]û" ";
	if (~1¦+/fd<4 Ý fdû"./-'"És Ý sgnû1-2«iÅ1 2) Ù`domain;

	(form;den)û(<Ä/fd)#¡(forms;dens);

	if (~^/whÅNUMS,'. ',(formÅ`decimal`integer)/',' Ý whûcÙs Ý cûÄ/sÉ"/-'") Ù`domain;
	if (~(nfrac-1)¤fracÉ'+' Ý plusû'+'Åfrac Ý fracûnfracÙt Ý nfracû+/' '¨tû(c+1)Õs) Ù`domain;
	bûformÅ`decimal_32nd `8th_32nd `decimal_64th;
	if (b) if (plus^nfrac=2) (frac;nfrac)û('0',frac;nfrac+1);
	if (plus^0=fu) Ù`domain;
	if (b) if (~3¦nfrac) Ù`domain;
	if (~^/fracÅNUMS,' ' Ý ((frac='+')/frac)û' ' Ý fracûnfracÙfrac) Ù`domain;
	if (b Ý kû(1-.9«(3=nfrac)^~plus)«_sfi{frac} Ý fracûfrac,(0=nfrac)#' 0') if (~den>k) Ù`domain;
	if (c Ý cûform=`8th_32nd) if (~8>10«1#0 1Îk) Ù`domain;

	comû','Åwh;
	sfiûcom#SFI;
	valûsfi¡{wh};

	if (c) kûd Ý kkû(k-dûÄk)ß25.6;
	valûval+kßden;
	if (c) valûval+kk;

	valûsgn«val+plus«.5ßden;

	if ((val<lw)©val>up) Ù`domain;

	prûif (form¨`decimal) nfrac else ¢1++/(©\wh='.')^wh¨' ';
	if (^/FORMSÅforms) formsû();
	bttrû(`form `plus `precision `forms `min `max `fuzz `comma;(form;plus;pr;forms;lw;up;fu;com));
	attrûdefault{bttr,¡(<~(0Øattr)Å0Øbttr)/¡attr};

	(`float©val;attr)
	}

out_{x}:
	{
	(val;attr)ûif (0=½x) (x;) else 2Ùx;
	attrû2Ùattr;
	formûif (`formÅ0Øattr) `formØattr else `decimal;
	prûif (`precisionÅ0Øattr) `precisionØattr else PRECS[FORMSÉform];
	zrûif (`zeroÅ0Øattr) `zeroØattr else 1;
	rnûif (`roundÅ0Øattr) `roundØattr else ¢1;
	blûif (`naÅ0Øattr) `naØattr else ¢999999999.0;
	wdûif (`widthÅ0Øattr) `widthØattr else 4+pr;
	comûif (`commaÅ0Øattr) `commaØattr else 0;
	if (1ÅvalÅbl) ûwdÙ' ';
	if (rn>¢1) valû(Ä.5+rn«val)ßrn;
	if ((0=pr)©(~zr)^val=Äval) formû`integer;
	if ((wd<2+pr)^form¨`integer) wdÒ'*'
	else case (form)
		{
		`integer;	{
				rû,_fmt{(com/"c"),"m<->i",îwd-pr+1;val};
ã				(wd+com«+/','=r)Ùr
				wdÙr
				};
		`decimal;	{
				rû,_fmt{(com/"c"),"m<->f",(îwd),".",îpr;val};
				if (~zr) (((r=".")^(" "=1Õr),0)/r)û" " Ý ((÷^\÷rÅ'0 ')/r)û" ";
				r
				};
		`decimal_32nd `decimal_64th `8th_32nd;
				{
				iû`decimal_32nd `decimal_64th `8th_32ndÉform;
				(den;dnf;sep)û(<i)#¡(32 64 32;10 10 8;"/'-");
				fracûden«1#num Ý whû0#num Ý numû0 1Î|val Ý sgnû«val;
				fracûif (2=pr) frac«10 Ý (t/frac)û0 Ý whûwh+tûfrac=den Ý fracûÄ.5+frac
				else +/(10~dnf)«@1 Û 0 1Îfrac Ý (t/frac)û0 Ý whûwh+tûfrac=den Ý fracû(Ä.5+frac«dnf)ßdnf;
				rlû(¢2Õ,_fmt{"m<->f",(î1+wd-pr),".1";(¢.1«¢1=sgn)+sgn«wh}),sep;
				rrû,_fmt{"zi3";frac};
				if (((pr<3)©~zr)^'0'=rr[2]) rr[2]û" ";
				if ((dnfß2)=10|Ä.5+frac) rr[2]û"+";
				if ('*'År Ý rûrl,rr) r[]û'*';
				rû(-' '=¢1Ùr)Õr;
				if (wd>#r) wdÙr else r
				}
		}
	}
