ãã Copyright (c) 1990-2008 Morgan Stanley All rights reserved.
ãã See .../src/LICENSE for terms of distribution.

$cx dio

in{s;d;i;p;c;v}:s.in{in_;d;i;p;c;v}
out{s;d;i;p;c;v}:s.out{out_;d;i;p;c;v}

forms{}:
	{
	ymdû`DDDDDDDD;
	(PARTS)û,<8;

	mdû`DSD `DSDD `DDSD `DDSDD;
	(PARTS)[,]û(1 1 1;1 1 2;2 1 1;2 1 2);

	mdyû`DSDSDD `DSDDSDD `DDSDSDD `DDSDDSDD;
	(PARTS)[,]û(1 1 1 1 2;1 1 2 1 2;2 1 1 1 2;2 1 2 1 2);

	mdyûmdy,`DSDSDDDD `DSDDSDDDD `DDSDSDDDD `DDSDDSDDDD;
	(PARTS)[,]û(1 1 1 1 4;1 1 2 1 4;2 1 1 1 4;2 1 2 1 4);

	(PICTURES)ûymd,md,mdy;
	(FORMS)û((#ymd)Ò`ymd),((#md)Ò`md),((#mdy)Ò`mdy);
	(WIDTHS)û(`md `mdy `ymd;(5;6;6));
	(CENTURIES)û(`md `mdy `ymd;(0;0;1));
	(FROM)û1960;
	(TO)û2100;
	}

forms{}

default{a}:
	{
	rû();
	(fm;yd)û(`mdy;0);

	if (`formÅ0Øa)		if (`mdy½fmû`formØa) 			r[,]û`form;
	if (`maxÅ0Øa) 		if (Inf½`maxØa) 			r[,]û`max;
	if (`minÅ0Øa) 		if (¢Inf½`minØa) 			r[,]û`min;
	if (`formsÅ0Øa) 	if (()½`formsØa) 			r[,]û`forms;
	if (`centuryÅ0Øa)	if ((fmØCENTURIES)½ydû`centuryØa) 	r[,]û`century;
	if (`naÅ0Øa)		if (¢999999999½`naØa)			r[,]û`na;
	if (`zeroÅ0Øa)		if (1½`zeroØa)				r[,]û`zero;
	if (`widthÅ0Øa)		if ((yd+fmØWIDTHS)½`widthØa)		r[,]û`width;

	if (0<#r) aû(<~(0Øa)År)/¡a;
	if (a½(;)) aû();
	a	
	}

in_{x}:
	{
	(x;attr)ûif (0=½x) (x;) else 2Ùx;
	attrû2Ùattr;

	blûif (`naÅ0Øattr) `naØattr else ¢999999999;
	if (^/x=' ' Ý sû,x) û(bl;attr);

	tûif (~`formsÅ0Øattr) FORMS else if (()½tû`formsØattr) FORMS else t;
	(forms;pics;parts)û(<(0ØFORMS)Åt)/¡(FORMS;PICTURES;PARTS);

	lwûif (`minÅ0Øattr) `minØattr else ¢Inf;
	upûif (`maxÅ0Øattr) `maxØattr else Inf;

	iûpicsÉÂs Ý ((s="/")/s)û"S" Ý ((sÅ"1234567890")/s)û"D" Ý sû(+/^\' '=s)÷s;
	if ((#pics)=i) Ù`domain;
	(fm;pt)û(i#forms;(iØparts)Úx);
	(val;digs)ûcase (fm)
		{
		`ymd;	in_ymd{pt};
		`mdy;	in_mdy{pt};
		`md;	in_md{pt};
		};

	if ((val<lw)©val>up) Ù`domain;

	formsûif (~^/FORMSÅforms) s.unique{forms}/forms;
	bttrû(`form `century `min `max `forms;(fm;digs;lw;up;forms));
	attrûdefault{bttr,¡(<~(0Øattr)Å0Øbttr)/¡attr};

	(`int©val;attr)
	}

in_ymd{parts}:
	{
	nûØâ¡parts;
	numû0 100 100În;
	if ((num[0]<FROM)©num[0]>TO) Ù`domain;
	mdû31 28 31 30 31 30 31 31 30 31 30 31;
	md[1]ûmd[1]+0=4|num[0];
	if ((num[1]<1)©num[1]>12) Ù`domain;
	if ((num[2]<1)©num[2]>(((1+É12)Énum[1])÷(md,0))[0]) Ù`domain;
	(n;1)
	}

in_mdy{parts}:
	{
	(m;d;y)û_sfi¡{0 2 4#parts};
	if (((y<FROM)^y>99)©(y>TO)©y<0) Ù`domain;
	yûy+(flagûy<100)«100«19+y<60;
	mdû31 28 31 30 31 30 31 31 30 31 30 31;
	md[1]ûmd[1]+0=4|y;
	if ((m<1)©m>12) Ù`domain;
	if ((d<1)©d>(((1+É12)Ém)÷(md,0))[0]) Ù`domain;
	(0 100 100Ây,m,d;4=2+2«~flag)
	}

in_md{parts}:
	{
	(m;d)û_sfi¡{0 2#parts};
	mdû31 29 31 30 31 30 31 31 30 31 30 31;
	if ((m<1)©m>12) Ù`domain;
	if ((d<1)©d>(((1+É12)Ém)÷(md,0))[0]) Ù`domain;
	(0 100Âm,d;0)
	}

out_{x}:
	{
	(val;attr)ûif (0=½x) (x;) else 2Ùx;
	attrû2Ùattr;
	fmûif (`formÅ0Øattr) `formØattr else `mdy;
	zrûif (`zeroÅ0Øattr) `zeroØattr else 1;
	blûif (`naÅ0Øattr) `naØattr else ¢999999999;
	ydû2 4[if (`centuryÅ0Øattr) `centuryØattr else fmØCENTURIES];
	wdûif (`widthÅ0Øattr) `widthØattr else yd+fmØWIDTHS;
	zûif (1ÅvalÅbl) wdÙ' '
	else case (fm)
		{
		`ymd;	,_fmt{"i8";val};
		`mdy;	out_mdy{val;zr;yd};
		`md;	out_md{val;zr}
		};
	if (wd¦#z) wdÙz else wdÒ'*'
	}

out_mdy{x;zr;yd}:(,_fmt{(zr/"z"),"i2";n[1]}),"/",(,_fmt{"zi2";n[2]}),"/",,_fmt{"zi",ît;(10*t)|n[0]} Ý tûyd Ý nû0 100 100Îx

out_md{x;zr}:(,_fmt{(zr/"z"),"i2";n[1]}),"/",,_fmt{"zi2";n[2]} Ý nû0 100 100Îx

wday{f;x}:
	{
	bû+\0 31 28 31 30 31 30 31 31 30 31 30;
	aûÒcû«x;
	if (~f)
		{
  		xû¢1+0 100 100Î,|x; x[É2;]û0 12Î12Âx[É2;];  
  		tûÄx[0;]Ê.ß4 100 400; tût[;0]-t[;1]-t[;2];
  		rûx[2;]+(365«x[0;])+t; rû366+r+b[x[1;]];
  		tû0=4 100 400 Ê.|x[0;]+1; tût[0;]¨t[1;]¨t[2;];
  		rûaÒr+(x[1;]¦2)^t;
		rûr-(a+1)«2>aû7|r;
		(0Äc«a<2)+c«(¢2+7|r)+5«Ärß7
		}
	else
		{
  		xû,|x; xû2+(5|x)+7«Äxß5; rûÄ(x-365)ß365.2425;
  		tû ÄrÊ.ß4 100 400; tût[;0]-t[;1]-t[;2];
  		xûx-365+(365«r)+t; dû(x=0)/ÉÒx; tûrÊ.+0 1; tû0=4 100 400Ê.|t;
  		eût[0;;]¨t[1;;]¨t[2;;]; bûe[;1]Ê.+b; b[;É2]û((Òx),2)Ò0 31; r[d]ûr[d]-1;
  		x[d]ûx[d]+364+e[d;0]; rû(r+1)~+/@1(xÊ.+12Ò0)>b;
  		xûx-(,b)[(12«ÉÒx)+r[1;]-1];
		c«aÒ100Âr,x
		}
	}

ARROWû'ý'

parse{x}:
	{
	iûxÉARROW Ý xû(x¨' ')/x;
	>0Ø¡dio.in_¡{(iÙx;(i+1)Õx)}
	}
